<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="JokeWorld">
    <meta name="author" content="Djem Suleyman">
    <title>JokeWorld</title>
   	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="css/index.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" rel="stylesheet" />
    <link href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css" rel="stylesheet" />
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script
        src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"
        integrity="sha256-hlKLmzaRlE8SCJC1Kw8zoUbU8BxA+8kR3gseuKfMjxA="
        crossorigin="anonymous"
    ></script>
    <script src="js/auth.js"></script>
  </head>
  <body>
	<div class="container-wrapper">
		<div class="container">
	      <header class="blog-header py-3 mb-3">
	        <div class="row flex-nowrap justify-content-between align-items-center">
	          <div class="col-4">
	          	<div id="welcome-message" class="text-white"></div>
	          	<div class="mt-2">
	          		<a id="edit-profile-btn" href="#">Edit profile</a>
	          	</div>
	          	<div class="mt-2">
	          		<a id="close-account-btn" href="#">Close you account</a>
	          	</div>
	          </div>
	          <div class="col-4 text-center">
	          	<img src="images/logo.png" alt="JokeWorld" height="100px" />
	          </div>
	          <div class="col-4 d-flex justify-content-end align-items-center">
	            <a id="logout-btn" class="btn btn-outline-primary logout-btn" href="#">Logout</a>
	          </div>
	        </div>
	      </header>
	    </div>
	</div>
    <main role="main" class="container mt-4">
      <div class="row">
        <div class="col-md-8 blog-main">
	          <h3 class="pb-3 mb-4 font-italic border-bottom d-flex justify-content-between">
	            <span>
	            	Jokes <span id="selectedCategory"></span>
	            </span>
	            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#joke-modal">
					Add Joke
				</button>
	          </h3>
	          
		  <div id="jokes-list"></div>
		  
		  <!-- Joke Item template -->
		  <div id="joke-template" class="d-none">
		  	<div class="card flex-md-row mb-4 box-shadow">
	            <div class="card-body d-flex flex-column align-items-start">
	              <strong id="joke-category" class="d-inline-block mb-2 text-success">Cateogry</strong>
	              <p id="joke-content" class="card-text mb-auto" style="white-space: pre-wrap;">Content.</p>
	              <div class="mt-3 mb-1 text-muted">
	              	  Created on <span id="joke-date">Date</span> 
		              by <b id="joke-author">Author</b>
		              <a id="joke-view-more" class="ml-3" href="#">View</a>
		              <a id="joke-edit" class="ml-3" href="#">Edit</a>
		              <a id="joke-delete" class="ml-3" href="#">Delete</a>
	              </div>
	            </div>
	          </div>
		  </div>
        </div>

        <aside class="col-md-4 blog-sidebar">
          <div class="p-3 mb-3 bg-light rounded">
            <h4 class="font-italic">Search</h4>
            <p>You can search by joke content</p>
	        <input id="inputSearch" type="text" class="form-control" placeholder="Type to search...">
          </div>

          <div class="p-3">
            <h4 class="font-italic">Categories</h4>
            <ol class="list-unstyled mb-0">
              <li><a href="?category=">All</a></li>
              <li><a href="?category=Kids">Kids</a></li>
              <li><a href="?category=Sport">Sport</a></li>
              <li><a href="?category=Games">Games</a></li>
              <li><a href="?category=Work">Work</a></li>
              <li><a href="?category=Other">Other</a></li>
            </ol>
          </div>
        </aside>
      </div>
    </main>
    
    <!-- Joke Modal -->
	<div class="modal fade" id="joke-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalLabel">Add Joke</h5>
	      </div>
	      <div class="modal-body">
	          <div class="form-group">
	          	<label for="inputContent">Content</label>
			  	<textarea class="form-control" placeholder="Describe your joke" id="inputContent" style="min-height: 50px; height: 100px" required></textarea>
			  </div>
			  <div class="form-group">
			  	  <label for="inputCategory">Category</label>
			      <select class="form-control" id="inputCategory">
					  <option value="Kids">Kids</option>
					  <option value="Sport">Sport</option>
					  <option value="Games">Games</option>
					  <option value="Work">Work</option>
					  <option value="Other">Other</option>
				  </select>
			  </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	        <button type="button" id="submit-joke-btn" class="btn btn-primary">Add</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<!-- Joke Edit Modal -->
	<div class="modal fade" id="joke-edit-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalLabel">Edit Joke</h5>
	      </div>
	      <div class="modal-body">
	          <div class="form-group">
	          	<label for="inputContent">Content</label>
			  	<textarea class="form-control" placeholder="Describe your joke" id="inputContent" style="min-height: 50px; height: 100px" required></textarea>
			  </div>
			  <div class="form-group">
			  	  <label for="inputCategory">Category</label>
			      <select class="form-control" id="inputCategory">
					  <option value="Kids">Kids</option>
					  <option value="Sport">Sport</option>
					  <option value="Games">Games</option>
					  <option value="Work">Work</option>
					  <option value="Other">Other</option>
				  </select>
			  </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	        <button type="button" id="edit-joke-btn" class="btn btn-primary">Edit</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<!-- Edit profile Modal -->
	<div class="modal fade" id="edit-profile-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalLabel">Edit Profile</h5>
	      </div>
	      <div class="modal-body">
	          <div class="form-group">
			      <label for="inputFirstName">First Name</label>
			      <input type="text" id="inputFirstName" class="form-control" placeholder="First Name" required>
		      </div>
		      <div class="form-group">
			      <label for="inputLastName">Last Name</label>
			      <input type="text" id="inputLastName" class="form-control" placeholder="Last Name" required>
			  </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	        <button type="button" id="submit-profile-btn" class="btn btn-primary">Edit</button>
	      </div>
	    </div>
	  </div>
	</div>
    <script>
    if(!localStorage.getItem("user")){
    	window.location.href="login.html"
    }
    
    $("#logout-btn").click((e)=>{
    	e.preventDefault();
    	logout();
    });
    
    let jokes=[];
    let userData = JSON.parse(localStorage.getItem("user"));
    
    const urlSearchParams = new URLSearchParams(window.location.search);
    if(urlSearchParams.get('category')){
    	$("#selectedCategory").text(" - "+urlSearchParams.get('category'))
    }
    const getPayloadForFetching = () => {
    	return {
        	category: urlSearchParams.get('category'),
        	phrase: $("#inputSearch").val()
        }
    }
    
    const fetchJokes = () => {
   		$.ajax({
   			url: "/jokes",
   			method: "GET",
   			data: getPayloadForFetching(),
   			contentType: "application/json; charset=utf-8",
   			success: (data) => {
   				jokes=data;
   				renderData();
   			},
   			error: (error) => {
   				alert(error);
   			}
   		});
    }
    
    const renderData = () => {
        $jokesList = $('#jokes-list');
        $jokesList.empty();
        jokes.forEach((joke) => $jokesList.append(createJokeCard(joke)));
    };
    
    // References to modals
    const createModal = new bootstrap.Modal($("#joke-modal"), { keyboard: false });
	const editModal = new bootstrap.Modal($("#joke-edit-modal"), { keyboard: false });
	const editProfileModal = new bootstrap.Modal($("#edit-profile-modal"), { keyboard: false });
    
    const createJokeCard = (joke) => {
        const $template = $($("#joke-template").html());
        $template.find('#joke-category').text(joke.category);
        $template.find('#joke-content').text(joke.content);
        $template.find('#joke-date').text(new Date(joke.createdDate).toLocaleString());
        $template.find('#joke-author').text(joke.user.firstName+" "+joke.user.lastName);
        $template.find('#joke-view-more').attr("href", "single.html?id="+joke.id);
        if(userData.id!==joke.user.id){
        	$template.find('#joke-edit').hide();
            $template.find('#joke-delete').hide();
        }
        $template.find("#joke-edit").click(e=>{
        	e.preventDefault();
        	$("#joke-edit-modal #inputContent").val(joke.content);
        	$("#joke-edit-modal #inputCategory").val(joke.category);
        	editModal.show();
        	
        	$("#edit-joke-btn").unbind().click((e)=>{
        		const payload = {
        			content: $("#joke-edit-modal #inputContent").val(),
        			category: $("#joke-edit-modal #inputCategory").val(),
        		}
        		$.ajax({
           			url: "/jokes?id="+joke.id,
           			method: "PUT",
           			data: JSON.stringify(payload),
           			contentType: "application/json; charset=utf-8",
           			success: (data) => {
           		    	editModal.hide();
           		    	fetchJokes();
           			},
           			error: (error) => {
           				if(typeof error.responseJSON.message==="string"){
           					alert(error.responseJSON.message);
           				}
           			}
           		});
            });
        });
        $template.find('#joke-delete').click(e=>{
        	e.preventDefault();
        	$.ajax({
       			url: "/jokes?id="+joke.id,
       			method: "DELETE",
       			contentType: "application/json; charset=utf-8",
       			success: (data) => {
       		    	fetchJokes();
       			},
       			error: (error) => {
       				if(typeof error.responseJSON.message==="string"){
       					alert(error.responseJSON.message);
       				}
       			}
       		});
        })
        return $template;
    };
    
    let timer = null;
  	$("#inputSearch").keyup((e)=>{
  		clearTimeout(timer);
        timer = setTimeout(fetchJokes, 800);
  	});
    
    getProfile();
    fetchJokes();
	
	$("#submit-joke-btn").click((e)=>{
		const payload = {
			content: $("#joke-modal #inputContent").val(),
			category: $("#joke-modal #inputCategory").val(),
		}
		$.ajax({
   			url: "/jokes/",
   			method: "POST",
   			data: JSON.stringify(payload),
   			contentType: "application/json; charset=utf-8",
   			success: (data) => {
   				$("#joke-modal #inputContent").val("");
   				$("#joke-modal #inputCategory").val("");
   		    	createModal.hide();
   		    	fetchJokes();
   			},
   			error: (error) => {
   				if(typeof error.responseJSON.message==="string"){
   					alert(error.responseJSON.message);
   				}
   			}
   		});
    });
	
	$("#edit-profile-btn").click((e)=>{
		e.preventDefault();
		userData = JSON.parse(localStorage.getItem("user")); // Update local variable
		$("#edit-profile-modal #inputFirstName").val(userData.firstName);
    	$("#edit-profile-modal #inputLastName").val(userData.lastName);
		editProfileModal.show(); // Open edit modal
	})
	$("#submit-profile-btn").click((e)=>{
		const payload = {
			firstName: $("#edit-profile-modal #inputFirstName").val(),
			lastName: $("#edit-profile-modal #inputLastName").val(),
		}
		$.ajax({
   			url: "/auth/edit-profile",
   			method: "PUT",
   			data: JSON.stringify(payload),
   			contentType: "application/json; charset=utf-8",
   			success: (data) => {
   				editProfileModal.hide();
   				getProfile();
   		    	fetchJokes();
   			},
   			error: (error) => {
   				if(typeof error.responseJSON.message==="string"){
   					alert(error.responseJSON.message);
   				}
   			}
   		});
    });
    </script>
   </body>
</html>